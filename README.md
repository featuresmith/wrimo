# Wrimo – Write more!

The global writing challenge where the reward is your own book.

## Overview

Wrimo is a statically generated site served by a Cloudflare Worker. The UI is built with Vite, and the Worker streams the built assets that live in Cloudflare's Worker asset storage. Spacelift executes the OpenTofu stack, which provisions the Worker shell, secrets, custom domains, and now uploads the Worker module and static assets using Terraform's `cloudflare_worker_version` resource.

## Development

The site is a simple static HTML page. To work on it locally:

1. Clone the repository
2. Install development tools using [mise](https://mise.jdx.dev/):
   ```bash
   mise install
   ```
   This will install the required Node.js version specified in `.mise.toml`
3. Install project dependencies:
   ```bash
   mise run install
   ```
4. Edit `index.html` as needed
5. Start the development server:
   ```bash
   mise run dev
   ```
6. Open http://localhost:5173 in your browser

### Preview the Worker locally

To validate the Worker runtime locally, build the production assets and run Wrangler's dev server against the Worker:

```bash
pnpm build
npx wrangler dev --assets dist
```

This serves the Worker at http://localhost:8787 using the same bundle the deployment workflow will upload.

## Deployment

Deployments are now driven entirely by Spacelift. When changes land on `main`, the Spacelift stack builds the site (`pnpm build`) and then applies the OpenTofu configuration. Terraform uploads the Worker module and static assets through the `cloudflare_worker_version` resource and immediately promotes that version via `cloudflare_workers_deployment`, so no separate Wrangler deployment step is required.

Because Terraform reads the build artifacts directly from `dist/`, always run `pnpm build` before executing `mise run tf-plan` or `mise run tf-apply` locally. The Spacelift pipeline performs the same build step automatically before applying.

### Terraform-managed Worker bundle

- `worker/index.js` defines the Worker module that proxies requests to the static asset storage exposed by Cloudflare.
- The Terraform stack reads that module (via `worker_main_module_path`) and the compiled static assets in `dist/` (via `worker_assets_directory`).
- `cloudflare_worker_version` uploads both the module and the assets, allowing Terraform to detect and publish changes without a custom CI job.
- `cloudflare_workers_deployment` pins 100% of traffic to the most recent version so deployments remain declarative.

### Spacelift stack configuration

Configure the Spacelift stack with the following environment variables or context:

- `CLOUDFLARE_API_TOKEN` – API token with Workers:Edit and Workers KV:Edit permissions so Terraform can upload the Worker and assets.
- `CLOUDFLARE_ACCOUNT_ID` – Cloudflare account identifier used by the provider.

Additional secrets (for example Worker secret values) continue to live in Spacelift and flow into Terraform via `worker_secrets`.

### Wrangler manifest for local preview

`wrangler.toml` remains in the repository so you can preview the Worker locally. After running `pnpm build`, execute `npx wrangler dev --assets dist` to serve the site from your machine using the same asset directory Terraform will upload.

## Infrastructure

Infrastructure is managed via OpenTofu in the `infra/` directory and executed through Spacelift. Spacelift owns the state backend and applies the Worker resources (script shell, secrets, and domain bindings) whenever infrastructure changes are merged.

### Setup

1. Copy the example variables file:
   ```bash
   cd infra
   cp terraform.tfvars.example terraform.tfvars
   ```

2. Edit `terraform.tfvars` with your actual values:
   - `cloudflare_account_id` - Your Cloudflare account ID
   - `cloudflare_api_token` - API token with appropriate permissions
   - `cloudflare_zone_id` - Zone ID that owns the Worker domains (required when `custom_domains` is non-empty)
   - `custom_domains` - List of hostnames to attach to the Worker (set to `[]` or `null` if none)
   - `worker_main_module_path` - Path to the Worker module (`../worker/index.js` by default)
   - `worker_assets_directory` - Path to the static asset build output (`../dist`, generated by `pnpm build`)

3. Initialize and apply:
   ```bash
   mise run tf-init
   mise run tf-plan
   mise run tf-apply
   ```

### State Management

OpenTofu state is automatically managed by Spacelift. No backend configuration is needed in `providers.tf` as Spacelift handles state storage in its managed backend.

### Spacelift automation

Spacelift runs the OpenTofu stack whenever infrastructure changes are merged to `main`, applying updates to the Worker script container, secrets, and custom domain bindings. Local runs (`mise run tf-plan` / `mise run tf-apply`) remain useful for validation, but the production lifecycle is driven by Spacelift.

## Contributing

Consult [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines on contributing to this project.

## License

TBD
